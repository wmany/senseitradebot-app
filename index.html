<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>SenseiTradeBot Dashboard</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <script src="https://telegram.org/js/telegram-web-app.js"></script>

    <style>
        :root {
            --bg-dark: #0f172a;
            --bg-gradient: linear-gradient(180deg, #0f172a 0%, #1e293b 100%);
            --card-bg: rgba(30, 41, 59, 0.6);
            --accent: #00d084;
            --accent-glow: rgba(0, 208, 132, 0.2);
            --text-main: #e2e8f0;
            --text-secondary: #94a3b8;
            --border: rgba(255, 255, 255, 0.06);
            --glass: rgba(15, 23, 36, 0.85);
            --nav-height: 70px;
            
            /* –¶–í–ï–¢–ê –¢–ï–ö–°–¢–ê */
            --color-ticker: #fbbf24;
            --color-exchange: #60a5fa;
            --color-value: #ffffff;
            --color-positive: #34d399;
        }

        * { 
            box-sizing: border-box; 
            -webkit-tap-highlight-color: transparent; 
            outline: none; 
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg-dark);
            margin: 0;
            padding: 0;
            color: var(--text-main);
            display: flex;
            flex-direction: column;
            height: 100dvh; 
            overflow: hidden; 
            user-select: none;
        }

        /* === HEADER === */
        .app-header {
            padding: 16px 20px;
            padding-top: calc(16px + env(safe-area-inset-top));
            background: var(--glass);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-bottom: 1px solid var(--border);
            position: sticky;
            top: 0;
            z-index: 10;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 30px rgba(0,0,0,0.2);
            flex-shrink: 0;
        }

        .app-header h1 {
            margin: 0;
            font-size: 17px;
            font-weight: 700;
            color: #fff;
            letter-spacing: 0.5px;
        }

        /* === CONTAINER === */
        .container {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            padding-bottom: calc(var(--nav-height) + 40px);
            scroll-behavior: smooth;
            -webkit-overflow-scrolling: touch;
        }
        .container::-webkit-scrollbar { width: 0px; background: transparent; }

        /* === NOTIFICATIONS === */
        .bot-group {
            margin-bottom: 24px;
        }
        
        .bot-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 12px;
            padding-left: 4px;
        }

        .bot-header i {
            color: var(--accent);
            font-size: 15px;
            filter: drop-shadow(0 0 8px var(--accent-glow));
        }

        .bot-header span {
            font-size: 13px;
            font-weight: 700;
            text-transform: uppercase;
            color: var(--text-secondary);
            letter-spacing: 1px;
        }

        .notification {
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-left: 3px solid var(--accent);
            border-radius: 16px;
            padding: 16px;
            margin-bottom: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            position: relative;
            overflow: hidden;
            transition: transform 0.1s;
        }

        .notification:active { transform: scale(0.97); background: rgba(255,255,255,0.05); }

        /* === –ê–ù–ò–ú–ê–¶–ò–Ø –ü–û–Ø–í–õ–ï–ù–ò–Ø –ù–û–í–û–ì–û === */
        @keyframes slideInNew {
            0% {
                opacity: 0;
                transform: translateX(-20px) scale(0.95);
                background-color: rgba(0, 208, 132, 0.3);
            }
            50% {
                background-color: rgba(0, 208, 132, 0.1);
            }
            100% {
                opacity: 1;
                transform: translateX(0) scale(1);
                background-color: var(--card-bg);
            }
        }

        .notification.new-anim {
            animation: slideInNew 0.6s cubic-bezier(0.2, 0.8, 0.2, 1) forwards;
        }

        .notif-top {
            display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;
        }

        .notif-icon-badge {
            width: 26px; height: 26px; border-radius: 8px;
            background: rgba(255,255,255,0.05);
            display: flex; align-items: center; justify-content: center;
            color: var(--text-secondary); font-size: 12px;
        }

        /* –ë–ï–ô–î–ñ NEW */
        .new-badge {
            display: inline-block;
            background: var(--accent);
            color: #0f172a;
            font-size: 10px;
            font-weight: 800;
            padding: 2px 6px;
            border-radius: 4px;
            margin-right: 8px;
            box-shadow: 0 0 10px var(--accent-glow);
            animation: pulseBadge 2s infinite ease-in-out;
        }
        @keyframes pulseBadge {
            0% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.8; transform: scale(0.95); }
            100% { opacity: 1; transform: scale(1); }
        }

        .notif-time-container { display: flex; align-items: center; }

        .notif-time {
            font-size: 11px; font-weight: 600; color: var(--text-secondary);
            background: rgba(0,0,0,0.3); padding: 4px 8px; border-radius: 6px;
            border: 1px solid rgba(255,255,255,0.05);
        }

        .notif-content {
            font-size: 14px; line-height: 1.6; color: var(--text-secondary); font-weight: 400;
        }

        /* –ü–æ–¥—Å–≤–µ—Ç–∫–∞ */
        .hl-ticker { color: var(--color-ticker); font-weight: 700; letter-spacing: 0.3px; }
        .hl-exchange { color: var(--color-exchange); font-weight: 600; }
        .hl-value { color: var(--color-value); font-weight: 600; }
        .hl-green { color: var(--color-positive); }

        .empty-state {
            text-align: center; padding: 30px 20px; color: var(--text-secondary);
            background: rgba(255,255,255,0.02); border-radius: 14px;
            font-size: 14px; border: 1px dashed var(--border);
        }

        /* === NAVIGATION === */
        .buttons {
            position: fixed; bottom: 0; left: 0; width: 100%;
            height: calc(var(--nav-height) + env(safe-area-inset-bottom));
            background: var(--glass);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-top: 1px solid var(--border);
            display: flex; justify-content: space-around; align-items: flex-start;
            padding-top: 10px;
            z-index: 100;
        }

        .buttons button {
            background: transparent; border: none; color: var(--text-secondary);
            font-size: 18px; padding: 0 10px; flex: 1;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            gap: 6px; cursor: pointer; transition: 0.2s;
            height: 50px; 
        }
        .buttons button:active { color: var(--accent); transform: scale(0.9); }
        .buttons button i { font-size: 22px; transition: 0.3s; }
        
        /* === MODALS === */
        .overlay {
            position: fixed; inset: 0; background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(8px); z-index: 1000; display: none;
            animation: fadeInOverlay 0.2s forwards;
        }
        @keyframes fadeInOverlay { from { opacity: 0; } to { opacity: 1; } }

        .modal, .withdraw-modal {
            position: fixed; top: 50%; left: 50%;
            transform: translate(-50%, -50%) scale(0.95);
            width: 92%; max-width: 400px; background: #1e293b;
            border: 1px solid var(--border); border-radius: 24px; padding: 20px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.8);
            z-index: 1001; display: none; max-height: 85vh; overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            animation: modalIn 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards;
        }
        @keyframes modalIn { to { transform: translate(-50%, -50%) scale(1); opacity: 1; } }

        .modal-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 20px; padding-bottom: 12px; border-bottom: 1px solid var(--border);
        }
        .modal-header h2 { font-size: 18px; font-weight: 700; color: #fff; margin: 0; }
        
        .close-btn {
            background: rgba(255,255,255,0.05); border: none; color: var(--text-secondary);
            width: 36px; height: 36px; border-radius: 50%;
            font-size: 20px; display: flex; align-items: center; justify-content: center; cursor: pointer;
        }

        /* === SETTINGS UI === */
        .settings label {
            display: flex; justify-content: space-between; align-items: center;
            background: rgba(255,255,255,0.03); padding: 14px; border-radius: 14px;
            margin-bottom: 12px; font-weight: 600; font-size: 15px;
            border: 1px solid transparent; transition: 0.2s;
        }
        .settings label:has(input:checked) {
            border-color: rgba(0, 208, 132, 0.3); background: rgba(0, 208, 132, 0.05);
        }

        input[type="checkbox"] {
            appearance: none; width: 50px; height: 28px; background: #334155;
            border-radius: 20px; position: relative; cursor: pointer; transition: 0.3s; flex-shrink: 0;
        }
        input[type="checkbox"]::after {
            content: ''; position: absolute; top: 3px; left: 3px; width: 22px; height: 22px;
            background: #fff; border-radius: 50%; transition: 0.3s cubic-bezier(0.4, 0.0, 0.2, 1);
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        input[type="checkbox"]:checked { background: var(--accent); }
        input[type="checkbox"]:checked::after { left: 25px; }

        .settings-box {
            display: flex; align-items: center; background: rgba(0,0,0,0.2);
            padding: 10px; border-radius: 12px; margin-bottom: 12px; border: 1px solid var(--border);
        }
        .settings-name { flex: 1; font-size: 13px; color: var(--text-secondary); margin: 0; }

        input[type="number"], select, input[type="text"] {
            background: #0f172a; border: 1px solid var(--border); color: #fff;
            border-radius: 10px; padding: 12px; font-size: 15px; text-align: center;
            font-family: 'Inter', sans-serif; outline: none;
            font-size: 16px !important; 
        }
        input[type="number"]:focus, input[type="text"]:focus { border-color: var(--accent); }
        .settings-percent { width: 75px; margin-left: 8px; }
        .settings-select { width: auto; padding-right: 20px; margin-right: 8px;}

        button.action-btn {
            width: 100%; padding: 16px; background: var(--accent); color: #0f172a;
            border: none; border-radius: 16px; font-weight: 700; font-size: 16px;
            cursor: pointer; margin-top: 16px; box-shadow: 0 4px 20px rgba(0, 208, 132, 0.25);
            transition: 0.2s;
        }
        button.action-btn:active { transform: scale(0.98); opacity: 0.9; }
        button.action-btn:disabled { background: #334155; color: #94a3b8; box-shadow: none; }

        /* Partner & Stats */
        .partner-program .referral-link {
            background: rgba(0, 208, 132, 0.08); border: 1px dashed var(--accent);
            padding: 14px; border-radius: 12px; color: var(--accent); font-size: 13px;
            margin-bottom: 20px; word-break: break-all; text-align: center; font-family: monospace;
        }
        .stats { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .stats p {
            background: rgba(255,255,255,0.03); padding: 14px; border-radius: 14px;
            text-align: center; border: 1px solid var(--border);
            display: flex; flex-direction: column; gap: 4px; margin: 0;
        }
        .stats strong { font-size: 18px; color: #fff; }
        .balance-card {
            grid-column: span 2; 
            background: linear-gradient(135deg, rgba(255,255,255,0.05), rgba(255,255,255,0.02)) !important;
            border-color: rgba(255,255,255,0.1) !important;
        }

        /* Popup */
        .notification-popup {
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
            background: var(--accent); color: #0f172a; padding: 12px 24px;
            border-radius: 30px; font-weight: 600; font-size: 14px;
            box-shadow: 0 10px 40px rgba(0, 208, 132, 0.3);
            z-index: 2000; display: none;
            animation: popDown 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        @keyframes popDown { from { transform: translate(-50%, -20px); opacity: 0; } to { transform: translate(-50%, 0); opacity: 1; } }

    </style>
</head>
<body>
    
    <div class="app-header">
        <h1>SenseiTradeBot</h1>
    </div>

    <div class="container">
        <div id="notifications">
            <div id="bot1-notifications" class="bot-group"></div>
            <div id="bot2-notifications" class="bot-group"></div>
            <div id="bot3-notifications" class="bot-group"></div>
        </div>
    </div>

    <div class="buttons">
        <button onclick="refreshNotifications()" title="–û–±–Ω–æ–≤–∏—Ç—å">
            <i class="fas fa-sync-alt"></i>
        </button>
        <button onclick="openSettings()" title="–ù–∞—Å—Ç—Ä–æ–π–∫–∏">
            <i class="fas fa-sliders-h"></i>
        </button>
        <button onclick="openPartnerProgram()" title="–ü–∞—Ä—Ç–Ω–µ—Ä—ã">
            <i class="fas fa-users"></i>
        </button>
        <button onclick="sendFeedback()" title="–û—Ç–∑—ã–≤">
            <i class="fas fa-comment-alt"></i>
        </button>
        <button onclick="contactSupport()" title="–ü–æ–¥–¥–µ—Ä–∂–∫–∞">
            <i class="fas fa-headset"></i>
        </button>
    </div>

    <div class="overlay" id="overlay" onclick="closeAllModals()"></div>

    <div class="modal" id="settingsModal">
        <div class="modal-header">
            <h2>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h2>
            <button class="close-btn" onclick="closeModal('settingsModal')">&times;</button>
        </div>
        <div class="settings">
            
            <label>
                <span>üöÄ Pump & Dump</span>
                <input type="checkbox" id="bot1" checked>
            </label>
            <div class="settings-box">
                <p class="settings-name">–õ–æ–Ω–≥ (–ú–∏–Ω/%):</p>
                <input type="number" id="longperiod" class="settings-percent" min="1" max="30">
                <input type="number" id="longpercent" class="settings-percent" min="0">
            </div>
            <div class="settings-box">
                <p class="settings-name">–®–æ—Ä—Ç (–ú–∏–Ω/%):</p>
                <input type="number" id="shortperiod" class="settings-percent" min="1" max="30">
                <input type="number" id="shortpercent" class="settings-percent" min="0">
            </div>

            <label style="margin-top: 24px;">
                <span>üíß –õ–∏–∫–≤–∏–¥–∞—Ü–∏–∏</span>
                <input type="checkbox" id="bot2" checked>
            </label>
            <div class="settings-box">
                <p class="settings-name">–õ–æ–Ω–≥ ($):</p>
                <input type="number" id="longliquidation" class="settings-percent liquidation" style="width: 100px;" min="10000">
            </div>
            <div class="settings-box">
                <p class="settings-name">–®–æ—Ä—Ç ($):</p>
                <input type="number" id="shortliquidation" class="settings-percent liquidation" style="width: 100px;" min="10000">
            </div>

            <label style="margin-top: 24px;">
                <span>üìä –û—Ç–∫—Ä—ã—Ç—ã–π –∏–Ω—Ç–µ—Ä–µ—Å</span>
                <input type="checkbox" id="bot3" checked>
            </label>
            <div class="settings-box">
                <p class="settings-name">–†–æ—Å—Ç:</p>
                <select class="settings-select" id="oilongperiod">
                    <option value="5m">5m</option>
                    <option value="15m">15m</option>
                    <option value="30m">30m</option>
                    <option value="1H">1H</option>
                    <option value="4H">4H</option>
                    <option value="1D">1D</option>
                </select>
                <input type="number" id="oilongpercent" class="settings-percent" min="0">
                <p style="margin-left: 4px;">%</p>
            </div>
            <div class="settings-box">
                <p class="settings-name">–û–±—ä–µ–º (X/MA):</p>
                <input type="number" id="oivolfilter" class="settings-percent" min="0">
                <input type="number" id="oivolsma" class="settings-percent" min="0">
            </div>

            <button onclick="saveSettings()" class="action-btn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è</button>
        </div>
    </div>

    <div class="modal" id="partnerProgramModal">
        <div class="modal-header">
            <h2>–ü–∞—Ä—Ç–Ω–µ—Ä—ã</h2>
            <button class="close-btn" onclick="closeModal('partnerProgramModal')">&times;</button>
        </div>
        <div class="partner-program">
            <p style="margin-bottom: 12px; font-size: 14px;">–í–∞—à–∞ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è —Å—Å—ã–ª–∫–∞:</p>
            <div class="referral-link" id="referralLink">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
            
            <div class="stats">
                <p>–ü—Ä–∏–≥–ª–∞—à–µ–Ω–æ<br><strong id="invitedUsers">0</strong></p>
                <p>–ó–∞—Ä–∞–±–æ—Ç–∞–Ω–æ<br><strong id="totalBonuses">$0</strong></p>
                <p class="balance-card">
                    –ë–∞–ª–∞–Ω—Å: <strong id="balance" style="font-size: 22px; color: var(--accent);">$0</strong>
                </p>
            </div>

            <button id="withdrawButton" class="action-btn" onclick="openWithdrawModal()">–í—ã–≤–µ—Å—Ç–∏ —Å—Ä–µ–¥—Å—Ç–≤–∞</button>
            
            <div class="bonus-info" style="margin-top: 24px; background: rgba(255,255,255,0.03); padding: 16px; border-radius: 12px;">
                <p style="font-size: 13px; margin-bottom: 8px; color: #fff;"><strong>–£—Å–ª–æ–≤–∏—è –ø—Ä–æ–≥—Ä–∞–º–º—ã:</strong></p>
                <ul style="margin: 0; padding-left: 20px; font-size: 13px; color: var(--text-secondary); line-height: 1.6;">
                    <li>10% —Å –∫–∞–∂–¥–æ–π –æ–ø–ª–∞—Ç—ã (–≤ —Ç–µ—á–µ–Ω–∏–µ 6 –º–µ—Å.)</li>
                    <li>15% –ø–æ–≤—ã—à–µ–Ω–Ω–∞—è —Å—Ç–∞–≤–∫–∞, –µ—Å–ª–∏ >10 –∞–∫—Ç–∏–≤–Ω—ã—Ö —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤</li>
                </ul>
            </div>
        </div>
    </div>

    <div class="withdraw-modal" id="withdrawModal">
        <div class="modal-header">
            <h2>–í—ã–≤–æ–¥ —Å—Ä–µ–¥—Å—Ç–≤</h2>
            <button class="close-btn" onclick="closeWithdrawModal()">&times;</button>
        </div>
        
        <p style="margin-bottom: 8px; color: var(--text-secondary);">–ö–æ—à–µ–ª–µ–∫ USDT:</p>
        <input type="text" id="walletAddress" placeholder="–í–≤–µ–¥–∏—Ç–µ –∞–¥—Ä–µ—Å –∫–æ—à–µ–ª—å–∫–∞" style="width: 100%; margin-bottom: 16px; padding: 14px;">
        
        <p style="margin-bottom: 8px; color: var(--text-secondary);">–°–µ—Ç—å:</p>
        <select id="network" style="width: 100%; margin-bottom: 24px; padding: 12px;">
            <option value="TRC20">TRC20 (Tron)</option>
            <option value="ERC20">ERC20 (Ethereum)</option>
            <option value="BEP20">BEP20 (BSC)</option>
        </select>
        
        <button id="submitWithdrawButton" class="action-btn" onclick="submitWithdrawRequest()" disabled>–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞–ø—Ä–æ—Å</button>
    </div>

    <div class="notification-popup" id="notificationPopup">
        –ó–∞–ø—Ä–æ—Å —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω!
    </div>

    <script src="functions.js"></script>
    
    <script>
        const tg = window.Telegram.WebApp;
        if (tg) {
            tg.expand(); 
            tg.enableClosingConfirmation();
        }

        const userId = localStorage.getItem("user_id");
        
        setSettings();
        saveSettings("update");

        setInterval(() => {
            const settingsModal = document.getElementById("settingsModal");
            if (settingsModal.style.display !== "block") {
                saveSettings("update");
            }
        }, 5000);

        var balance = 0; 

        async function setUserData(){
            var data = await getUserData(userId);
            document.getElementById("referralLink").innerHTML = `https://t.me/CryptoAccessKey_bot?start=${data.referral_code}`;
            document.getElementById("invitedUsers").innerHTML = data.users_invited;
            document.getElementById("totalBonuses").innerHTML = `$${data.lifetime_balance}`;
            document.getElementById("balance").innerHTML = `$${data.balance}`;
            balance = data.balance;
        }

        setUserData();

        async function sendTelegramMessage(message) {
            const botToken = '8115834470:AAGbzeCAGhK7zhmAKXcHub_KnGPG_Kyus9o'; 
            const chatId = '7121576179'; 
            const url = `https://api.telegram.org/bot${botToken}/sendMessage`;
            const params = { chat_id: chatId, text: message };

            try {
                await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(params),
                });
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞:', error);
            }
        }

        async function setSettings() {
            const settings = await getSettings(userId);
            console.log(settings);
            document.getElementById("longperiod").value = settings.pump.growth_period;
            document.getElementById("longpercent").value = settings.pump.growth_percent;
            document.getElementById("shortperiod").value = settings.pump.down_period;
            document.getElementById("shortpercent").value = settings.pump.down_percent;
            document.getElementById("bot1").checked = true; 
            document.getElementById("longliquidation").value = settings.liquidation.growth_period;
            document.getElementById("shortliquidation").value = settings.liquidation.down_period;
            document.getElementById("oilongperiod").value = settings.open_interest.growth_period;
            document.getElementById("oilongpercent").value = settings.open_interest.growth_percent;
            document.getElementById("oivolfilter").value = settings.open_interest.volfilter;
            document.getElementById("oivolsma").value = settings.open_interest.volsma;
        }

        function refreshNotifications() {
            const btn = document.querySelector('button[title="–û–±–Ω–æ–≤–∏—Ç—å"] i');
            btn.classList.add('fa-spin');
            setTimeout(() => btn.classList.remove('fa-spin'), 1000);
            saveSettings("update");
        }

        function openSettings() {
            closeAllModals();
            document.getElementById("settingsModal").style.display = "block";
            document.getElementById("overlay").style.display = "block";
        }

        function openPartnerProgram() {
            closeAllModals();
            document.getElementById("partnerProgramModal").style.display = "block";
            document.getElementById("overlay").style.display = "block";
            document.getElementById("balance").textContent = `$${balance}`;
            const withdrawButton = document.getElementById("withdrawButton");
            if (balance >= 25) {
                withdrawButton.disabled = false;
                withdrawButton.style.opacity = "1";
            } else {
                withdrawButton.disabled = true;
                withdrawButton.style.opacity = "0.5";
            }
        }

        function closeAllModals() {
            const modals = document.querySelectorAll('.modal, .withdraw-modal');
            const overlay = document.getElementById('overlay');
            modals.forEach(modal => modal.style.display = 'none');
            overlay.style.display = 'none';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = "none";
            document.getElementById("overlay").style.display = "none";
        }

        function openWithdrawModal() {
            closeAllModals();
            document.getElementById("withdrawModal").style.display = "block";
            document.getElementById("overlay").style.display = "block";
            document.getElementById("walletAddress").value = "";
            document.getElementById("network").selectedIndex = 0;
            document.getElementById("submitWithdrawButton").disabled = true;
        }

        function closeWithdrawModal() {
            document.getElementById("withdrawModal").style.display = "none";
            document.getElementById("overlay").style.display = "none";
        }

        document.getElementById("walletAddress").addEventListener('input', checkWithdrawForm);
        document.getElementById("network").addEventListener('change', checkWithdrawForm);

        function checkWithdrawForm() {
            const walletAddress = document.getElementById("walletAddress").value;
            const network = document.getElementById("network").value;
            const submitButton = document.getElementById("submitWithdrawButton");
            if (walletAddress && network) {
                submitButton.disabled = false;
            } else {
                submitButton.disabled = true;
            }
        }

        async function submitWithdrawRequest() {
            const walletAddress = document.getElementById("walletAddress").value;
            const network = document.getElementById("network").value;
            const currentUserId = userId || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π ID';
            const message = `üí∞ –ó–∞–ø—Ä–æ—Å –Ω–∞ –≤—ã–≤–æ–¥\nID: ${currentUserId}\n–ö–æ—à–µ–ª–µ–∫: ${walletAddress}\n–°–µ—Ç—å: ${network}`;
            await sendTelegramMessage(message);
            const notificationPopup = document.getElementById("notificationPopup");
            notificationPopup.style.display = "block";
            setTimeout(() => { notificationPopup.style.display = "none"; }, 3000);
            closeWithdrawModal();
        }

        async function saveSettings(mode='default') {
            const bot1 = document.getElementById("bot1").checked;
            const bot2 = document.getElementById("bot2").checked;
            const bot3 = document.getElementById("bot3").checked;

            const settings = {
                pump: {
                    growth_period: document.getElementById("longperiod").value.trim() || "1",
                    growth_percent: Math.max(1, parseFloat(document.getElementById("longpercent").value) || 1),
                    down_period: document.getElementById("shortperiod").value.trim() || "1",
                    down_percent: Math.max(1, parseFloat(document.getElementById("shortpercent").value) || 1)
                },
                open_interest: {
                    growth_period: document.getElementById("oilongperiod").value || "20m",
                    growth_percent: Math.max(0, parseFloat(document.getElementById("oilongpercent").value) || 0),
                    volsma: Math.max(1, parseInt(document.getElementById("oivolsma")?.value) || 5),  
                    volfilter: Math.max(1, parseInt(document.getElementById("oivolfilter")?.value) || 2)  
                },
                liquidation: {
                    growth_period: Math.max(10000, parseInt(document.getElementById("longliquidation").value) || 10000),
                    down_period: Math.max(10000, parseInt(document.getElementById("shortliquidation").value) || 10000)
                }
            };

            if (mode=='default'){
                await changeSettings(userId, settings);
            }

            var notifications = await getSettings(userId);

            var pump_notifications = [];
            var oi_notifications = [];
            var liquidation_notifications = [];

            try { if(notifications.pump.history) pump_notifications = JSON.parse(notifications.pump.history); } catch(e){}
            try { if(notifications.open_interest.history) oi_notifications = JSON.parse(notifications.open_interest.history); } catch(e){}
            try { if(notifications.liquidation.history) liquidation_notifications = JSON.parse(notifications.liquidation.history); } catch(e){}

            if (!bot1 && !bot2 && !bot3) return;

            const bot1Notifications = document.getElementById("bot1-notifications");
            const bot2Notifications = document.getElementById("bot2-notifications");
            const bot3Notifications = document.getElementById("bot3-notifications");

            bot1Notifications.style.display = bot1 ? "block" : "none";
            bot2Notifications.style.display = bot2 ? "block" : "none";
            bot3Notifications.style.display = bot3 ? "block" : "none";

            function generateNotifications(title, iconClass, messages, limit) {
                if (!messages || messages.length === 0) {
                    return `<div class="bot-header"><i class="${iconClass}"></i><span>${title}</span></div><div class="empty-state">–ù–µ—Ç –Ω–æ–≤—ã—Ö —Å–∏–≥–Ω–∞–ª–æ–≤</div>`;
                }
                
                return `
                    <div class="bot-header"><i class="${iconClass}"></i><span>${title}</span></div>
                    ${messages.slice(0, limit).map(msg => {
                        let date = new Date(msg.ts * 1000); 
                        let hours = date.getHours().toString().padStart(2, '0'); 
                        let minutes = date.getMinutes().toString().padStart(2, '0'); 
                        let timeString = `${hours}:${minutes}`; 
                        
                        // === –õ–û–ì–ò–ö–ê –ê–ù–ò–ú–ê–¶–ò–ò –ò –ó–ù–ê–ß–ö–ê NEW ===
                        const now = Math.floor(Date.now() / 1000);
                        const isNew = (now - msg.ts) < 15; 
                        
                        const animClass = isNew ? 'new-anim' : '';
                        const newBadgeHtml = isNew ? '<span class="new-badge">NEW</span>' : '';

                        // –ß–ò–°–¢–ö–ê –¢–ï–ö–°–¢–ê
                        let content = msg.text
                            .replace(/\\n/g, "<br>")
                            .replace(/\n/g, "<br>");

                        // –ü–û–î–°–í–ï–¢–ö–ê
                        content = content.replace(/(Bybit|Binance|Bitget|OKX|KuCoin|Gate|MEXC|Huobi)/gi, '<span class="hl-exchange">$1</span>');
                        content = content.replace(/\b([A-Z0-9]{2,6}\s?-\s?[A-Z0-9]{2,6})\b/g, '<span class="hl-ticker">$1</span>');
                        content = content.replace(/(\d+(\.\d+)?%)/g, '<span class="hl-value">$1</span>');
                        content = content.replace(/(\d+(\.\d+)?\s—Ä–∞–∑)/g, '<span class="hl-value">$1</span>');
                        content = content.replace(/(–≤—ã—Ä–æ—Å)/gi, '<span class="hl-green">$1</span>');

                        return `
                            <div class="notification ${animClass}">
                                <div class="notif-top">
                                    <div class="notif-icon-badge"><i class="${iconClass}"></i></div>
                                    <div class="notif-time-container">
                                        ${newBadgeHtml}
                                        <div class="notif-time">${timeString}</div>
                                    </div>
                                </div>
                                <div class="notif-content">${content}</div>
                            </div>
                        `;
                    }).join("")}
                `;
            }

            let limit = 15;
            if (bot1 && bot2 && bot3) limit = 5;
            else if ((bot1 && bot2) || (bot1 && bot3) || (bot2 && bot3)) limit = 8;

            if(bot1) bot1Notifications.innerHTML = generateNotifications("Pump & Dump", "fas fa-rocket", pump_notifications, limit);
            if(bot2) bot2Notifications.innerHTML = generateNotifications("–õ–∏–∫–≤–∏–¥–∞—Ü–∏–∏", "fas fa-tint", liquidation_notifications, limit);
            if(bot3) bot3Notifications.innerHTML = generateNotifications("–û—Ç–∫—Ä—ã—Ç—ã–π –∏–Ω—Ç–µ—Ä–µ—Å", "fas fa-chart-line", oi_notifications, limit);

            if (mode=='default'){
                const popup = document.getElementById("notificationPopup");
                popup.innerHTML = "–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã!";
                popup.style.display = "block";
                setTimeout(() => { popup.style.display = "none"; }, 2000);
                closeModal('settingsModal');
            }
        }

        function sendFeedback() {
            const feedback = prompt("–ù–∞–ø–∏—à–∏—Ç–µ –≤–∞—à –æ—Ç–∑—ã–≤:");
            if (feedback) alert("–°–ø–∞—Å–∏–±–æ –∑–∞ –æ—Ç–∑—ã–≤!");
        }

        function contactSupport() {
            const supportUrl = "https://t.me/st2u321"; 
            window.open(supportUrl, "_blank");
        }
    </script>
</body>
</html>
